---
title: "p8105_hw5_ly2565"
author: "Lin Yang"
date: "11/11/2021"
output: github_document
---

```{r, setup, include = FALSE}
library(tidyverse)


knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

## Problem 1

### Load and describe the raw dataset

```{r}
homicide_raw = read_csv("data/homicide-data.csv")
```
This raw homicide dataset contains `r nrow(homicide_raw)` observations of `r ncol(homicide_raw)` variables: `r names(homicide_raw)`.

### Clean the dataset

Summarize total number of homicides and the number of unsolved homicides within cities.
```{r}
homicide_df = 
  homicide_raw %>% 
  janitor::clean_names() %>% 
  mutate(
    state = ifelse(city == "Tulsa", "OK", state),
    city_state = str_c(city, state, sep = ", "))

##total number of homicides by cities
total = homicide_df %>% 
  group_by(city_state) %>% 
  summarize(n_total = n()) 
  
##number of unsolved homicides by cities
unsolved = homicide_df %>% 
  filter(disposition != "Closed by arrest") %>% 
  group_by(city_state) %>% 
  summarize(n_unsolved = n())

homicide_prop = left_join(total, unsolved)
  
homicide_prop
```

### Proportion of unsolved homicides

Run `prop.test` for Baltimore, MD.
```{r}
baltimore = homicide_prop %>% 
  filter(city_state == "Baltimore, MD")
baltimore_prop = 
  prop.test(pull(baltimore, n_unsolved), pull(baltimore, n_total), alternative = "two.sided", conf.level = 0.95) %>% 
  broom::tidy() %>% 
  select(estimate, conf.low, conf.high)

baltimore_prop
```

Run `prop.test` for each city.
```{r}
homicide_test = 
  homicide_prop %>%
  mutate(
    prop_test = map2(.x = n_unsolved, .y = n_total, ~prop.test(x = .x, n = .y, alternative = "two.sided", conf.level = 0.95)),
    test_stats = map(prop_test, broom::tidy)) %>% 
  unnest(cols = test_stats) %>% 
  select(city_state, n_total, n_unsolved, estimate, conf.low, conf.high )

homicide_test
```

Scatterplot showing the estimates and CIs for each city.

```{r, dpi = 300, echo=FALSE}
homicide_test %>% 
  mutate(city_state = fct_reorder(city_state, estimate)) %>% 
  ggplot(aes(x = city_state, y = estimate, color = city_state)) +
  geom_point() +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(
    x = "City",
    y = "Estimated Proportion of Unsolved Homicides",
    color = "Cities",
    title = "Estimated Proportion of Unsolved Homicides in Each City"
  )
```


## Problem 2

```{r, message = FALSE, dpi = 300}
df = tibble(
  file = list.files("data/data2")) %>% 
  mutate(
    id = str_remove(file, ".csv"),
    path = str_c("data/data2/", file),
    data = map(path, read_csv)) %>% 
  unnest(data) %>% 
  select(-file, -path) %>% 
  pivot_longer(
    week_1:week_8,
    names_to = "week",
    names_prefix = "week_",
    values_to = "data"
  ) %>% 
  separate(id, into = c("group", "id"))

df %>% 
  ggplot(aes(x = week, y = data, group = interaction(group, id), color = group)) +
  geom_line() +
  labs(
    x = "Week",
    y = "Data",
    color = "Group"
  )
  
```









